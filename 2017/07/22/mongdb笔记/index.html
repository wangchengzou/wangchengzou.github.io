<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    

    <title>mongdb笔记 | 千帆渡</title>
    <meta name="author" content="汪成邹">
    
    <meta name="description" content="前端有我，我会前端">
    
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta property="og:title" content="mongdb笔记"/>
    <meta property="og:site_name" content="~~博客园~~"/>

    
    <meta property="og:image" content="undefined"/>
    

    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="alternate" href="/atom.xml" title="~~博客园~~" type="application/atom+xml">
    <link rel="stylesheet" href="/css/lib/materialize.min.css">
    <link rel="stylesheet" href="/css/lib/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

    
        <link rel="stylesheet" href="/css/lib/prettify-tomorrow-night-eighties.css" type="text/css">
    
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>


<body>
    <img src="/weixin_favicon.png" style="position: absolute; left: -9999px; opacity: 0; filter: alpha(opacity=0);">

    <nav class="indigo">
    <div class="nav-wrapper">
        <a href="#" data-activates="main-menu" class="button-collapse">
            <i class="fa fa-navicon"></i>
        </a>
        <div class="">
            <a href="/" class="brand-logo hide-on-med-and-down">~~博客园~~</a>
            <ul class="right hide-on-med-and-down">
                
                    <li>
                        <a class="menu-home " href="/" >
                            <i class="fa fa-home "></i>
                            
                            首页
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-archive " href="/archives" >
                            <i class="fa fa-archive "></i>
                            
                            归档
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                            <i class="fa fa-bookmark "></i>
                            
                            分类
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-reading " href="/reading" >
                            <i class="fa fa-book "></i>
                            
                            读书
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-about " href="/about" >
                            <i class="fa fa-user "></i>
                            
                            关于
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-search modal-trigger " href="#search" >
                            <i class="fa fa-search "></i>
                            
                            搜索
                        </a>
                    </li>
                
            </ul>
            <div>
    <ul class="side-nav indigo darken-1" id="main-menu">
        
        <li class="side-user">
            <div class="row">
                <div class="col s4 no-padding">
                    <img class="avatar-image circle responsive-img" src="http://wx3.sinaimg.cn/mw690/006JXC2kgy1fhtihebefjj31i0200e81.jpg" alt="User Avatar">
                </div>
                <div class="info col s8 valign-wrapper no-padding">
                    <div class="valign">
                        <p class="name">汪成邹</p>
                        <p class="desc">Web前端/H5/技术宅</p>
                    </div>
                </div>
            </div>
        </li>
        

        
            <li class="no-padding">
                <a class="waves-effect menu-home " href="/" >
                    <i class="fa fa-home "></i>
                    
                    首页
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-archive " href="/archives" >
                    <i class="fa fa-archive "></i>
                    
                    归档
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                    <i class="fa fa-bookmark "></i>
                    
                    分类
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-reading " href="/reading" >
                    <i class="fa fa-book "></i>
                    
                    读书
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-about " href="/about" >
                    <i class="fa fa-user "></i>
                    
                    关于
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-search modal-trigger " href="#search" >
                    <i class="fa fa-search "></i>
                    
                    搜索
                </a>
            </li>
        
    </ul>

    <ul class="side-nav indigo darken-1" id="category-menu">
    

            

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/学习笔记/">
                    学习笔记 <span class="right">26 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/面试题目/">
                    面试题目 <span class="right">8 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/算法和函数/">
                    算法和函数 <span class="right">3 篇</span></a>
                </a>
            </li>

        

    </ul>
</div>

        </div>
    </div>
</nav>

<div id="search" class="modal search-modal">
    <div class="row">
        <div class="input-field col s12">
              <input id="search-input" type="text">
              <label for="search-input">搜索</label>
        </div>

    </div>
    <div id="search-result" class="search-result col s12">

    </div>
</div>


    <main>
        <div class="container main-container">
    <nav class="page-nav hide-on-small-only">
    <div class="nav-wrapper indigo">
        <span class="breadcrumb">当前位置（分类目录）</span>
        
            
    
    
    <a class="breadcrumb" href="/categories/学习笔记/">学习笔记</a>


        

        
    </div>
</nav>

<article>
    <div class="card">
        <div class="card-content">
            

            <div class="article-title">
                
    
        <h1>mongdb笔记</h1>
    


            </div>
            <time class="pink-link-context" datetime="2017-07-22T15:48:26.000Z"><a href="/2017/07/22/mongdb笔记/">2017-07-22</a></time>

            <span id="busuanzi_container_page_pv" class="read-times-container">
    <i class="fa fa-eye"></i>
    <span id="busuanzi_value_page_pv"></span>
</span>

            
    <div class="tags-row">
        
            <a href="/tags/mongdb/" class="chip pink lighten-1">mongdb</a>
        
            <a href="/tags/nosql/" class="chip pink lighten-1">nosql</a>
        
    </div>


            <div class="toc pink-link-context hide-on-med-and-down">
    
</div>


            <div class="entry pink-link-context">
                <p>1、安装mongodb</p>
<pre><code>下载mongodb www.mongodb.org  下载最新的stable版
解压文件
不用编译,本身就是编译后的二进制可执行文件.
 启动mongod服务
./bin/mongod.exe --dbpath *** (***代表数据库存放地址)
/path/to/database --logpath 
/path/to/log --fork --port 27017
参数解释:
--dbpath 数据存储目录
--logpath 日志存储目录
--port 运行端口(默认27017)
--fork 后台进程运行

设置启动文件（.bat）
启动帮助 cmd mongod -help
</code></pre><p>2、配置客户端</p>
<pre><code>mongo 127.0.0.1:27017/admin
</code></pre><p>3、创建一个数据库</p>
<pre><code>use 库名
</code></pre><p>4、查看所有数据库</p>
<pre><code>show dbs
</code></pre><p>5、查看数据库中的所有文档</p>
<pre><code>show collections
</code></pre><p> 6、查看数据库中文档里的数据</p>
<pre><code>db.[文档名]persons.find()
</code></pre><p> 7、更新文档数据</p>
<pre><code>db.persons.update({name:&quot;uspcat&quot;},{$set:{name:&quot;uspcat1&quot;}})
var p=db.persons.findOne();
db.persons.update(p,{name:&quot;uspcat&quot;})
</code></pre><p> 8、删除文档中的数据</p>
<pre><code>db.[name].remove({})
db.persons.remove({name:&quot;uspcat&quot;})
</code></pre><p> 9、增加一条数据<br>        db.persons.insert({})</p>
<p> 10、删除数据集合<br>        db.[].drop()</p>
<p> 11、删除数据库<br>        db.dropDatabase</p>
<p>12、查看帮助</p>
<pre><code>db.help
db.persons.help
</code></pre><p>13、插入批量文档</p>
<pre><code>for 循环插入数据
</code></pre><p>14、针对id一样时候的处理</p>
<pre><code>db.persons.save({})会替换之前数据
db.persons.insert({})会报错
</code></pre><p>15、runCommand函数和findAndModify函数</p>
<pre><code>runCommand可以执行mongoDB中的特殊函数
findAndModify就是特殊函数之一他的用于是返回update或remove后的文档
 runCommand({“findAndModify”:”processes”,
      query:{查询器},
   sort{排序},
    new:true
   update:{更新器},
   remove:true
  }).value
   ps = db.runCommand({
          &quot;findAndModify&quot;:&quot;persons&quot;,
          &quot;query&quot;:{&quot;name&quot;:&quot;text&quot;},
         &quot;update&quot;:{&quot;$set&quot;:{&quot;email&quot;:&quot;1221&quot;}},
         &quot;new&quot;:true 
   }).value
   do_something(ps
</code></pre><p>16、find的使用方法</p>
<pre><code>1.指定返回的键
db.[documentName].find ({条件},{键指定})
     数据准备persons.json
 查询出所有数据的指定键(name ,age ,country)
db.persons.find({},{name:1,age:1,country:1,_id:0})

2.查询条件
     2.1查询出年龄在25到27岁之间的学生
   db.persons.find({age: {$gte:25,$lte:27},{_id:0,age:1})
    2.2查询出所有不是韩国籍的学生的数学成绩
   db.persons.find({country:{$ne:” Korea”}},{_id:0,m:1})
3.包含或不包含
   $in或$nin
   2.3查询国籍是中国或美国的学生信息
   db.persons.find({country:{$in:[“USA”,“China”]}})
   2.4查询国籍不是中国或美国的学生信息
   db.persons.find({country:{$nin:[“USA”,“China”]}})
4.OR查询
        $or
   2.4查询语文成绩大于85或者英语大于90的学生信息
  db.persons.find({$or:[{c:{$gte:85}},{e:{$gte:90}}]},{_id:0,c:1,e:1})
5.Null
  把中国国籍的学生上增加新的键sex
  db.person.update({country:”China”},{$set:{sex:”m”}})
  2.5查询出sex 等于 null的学生
  db.persons.find({sex:{$in:[null]}},{country:1})
6.正则查询
    2.6查询出名字中存在”li”的学生的信息
    db.persons.find({name:/li/i},{_id:0,name:1}) 
7.$not的使用
  $not可以用到任何地方进行取反操作
    2.7查询出名字中不存在”li”的学生的信息
    db.persons.find({name:{$not:/li/i}},{_id:0,name:1})
    $not和$nin的区别是$not可以用在任何地方儿$nin是用到集合上的
8.数组查询$all和index应用
  2.8查询喜欢看MONGOD和JS的学生
   db.persons.find({books:{$all:[“MONGOBD”,”JS”]}},{books:1,_id:0})
   2.9查询第二本书是JAVA的学习信息
   db.persons.find({“books.1”:”JAVA”})
9.查询指定长度数组$size它不能与比较查询符一起使用(这是弊端)
   2.8查询出喜欢的书籍数量是4本的学生
   db.persons.find({books:{$size:4}},{_id:0,books:1})
    2.9查询出喜欢的书籍数量大于3本的学生
   1.增加字段size
    db.persons.update({},{$set:{size:4}},false, true)
   2.改变书籍的更新方式,每次增加书籍的时候size增加1
       db.persons.update({查询器},{$push:{books:”ORACLE”},$inc:{size:1}})
   3.利用$gt查询
       db.persons.find({size:{$gt:3}})
   2.10利用shell查询出Jim喜欢看的书的数量
        var persons = db.persons.find({name:&quot;jim&quot;})
        while(persons.hasNext()){
            obj = persons.next();
                print(obj.books.length)
        } 
10.$slice操作符返回文档中指定数组的内部值
   2.11查询出Jim书架中第2~4本书
   db.persons.find({name:&quot;jim&quot;},{books:{&quot;$slice&quot;:[1,3]}})
   2.12查询出最后一本书
  db.persons.find({name:&quot;jim&quot;},{books:{&quot;$slice&quot;:-1},_id:0,name:1})
11.文档查询
  为jim添加学习简历文档 jim.json
  2.13查询出在K上过学的学生
  1. 这个我们用绝对匹配可以完成,但是有些问题(找找问题?顺序?总要带着score?)
       db.persons.find({school:{school:&quot;K&quot;,score:&quot;A&quot;}},{_id:0,school:1})
  2.为了解决顺序的问题我可以用对象”.”的方式定位
       db.persons.find({&quot;school.score&quot;:&quot;A&quot;,&quot;school.school&quot;:&quot;K&quot;},{_id:0,school:1})
  3.这样也问题看例子:
     db.persons.find({&quot;school.score&quot;:&quot;A&quot;,&quot;school.school&quot;:”J”},{_id:0,school:1})
      同样能查出刚才那条数据,原因是score和school会去其他对象对比
  4.正确做法单条条件组查询$elemMatch
       db.persons.find({school:{$elemMatch:{school:&quot;K&quot;,score:&quot;A&quot;}}})
12.$where
  12.查询年龄大于22岁,喜欢看C++书,在K学校上过学的学生信息
        复杂的查询我们就可以用$where因为他是万能
        但是我们要尽量避免少使用它因为他会有性能的代价
    1.Limit返回指定的数据条数
        1.1查询出persons文档中前5条数据
        db.persons.find({},{_id:0,name:1}).limit(5)
    2.Skip返回指定数据的跨度
        2.1查询出persons文档中5~10条的数据
        db.persons.find({},{_id:0,name:1}).limit(5).skip(5)
    3.Sort返回按照年龄排序的数据[1,-1]
        db.persons.find({},{_id:0,name:1,age:1}).sort({age:1})
        注意:mongodb的key可以存不同类型的数据排序就也有优先级
        最小值
        null
        数字
        字符串
        对象/文档
        数组
        二进制
        对象ID
        布尔
        日期
         时间戳  正则  最大值  

    4.Limit和Skip完成分页
    4.1三条数据位一页进行分页
          第一页db.persons.find({},{_id:0,name:1}).limit(3).skip(0)
          第二页db.persons.find({},{_id:0,name:1}).limit(3).skip(3)
    4.2skip有性能问题,没有特殊情况下我们也可以换个思路
          对文档进行重新解构设计
</code></pre><p>17、利用游标完成查询数据</p>
<pre><code>1.游标
    利用游标遍历查询数据
    var  persons = db.persons.find();
    while(persons.hasNext()){
        obj = persons.next();
          print(obj.name)
     } 
2.游标几个销毁条件
    1.客户端发来信息叫他销毁
    2.游标迭代完毕
    3.默认游标超过10分钟没用也会别清除
3.查询快照
    快照后就会针对不变的集合进行游标运动了,看看使用方法.
    db.persons.find({$query:{name:”Jim”},$snapshot:true})
    高级查询选项
    $query
    $orderby
    $maxsan：integer 最多扫描的文档数
    $min：doc  查询开始
    $max：doc  查询结束
    $hint：doc   使用哪个索引
    $explain:boolean  统计
    $snapshot:boolean 一致快照
</code></pre><p>18、索引详讲</p>
<pre><code>1.创建简单索引
    数据准备index.js
    1.先检验一下查询性能
        var start = new Date()
        db.books.find({number:65871})
        var end = new Date()
        end - start
     2.为number 创建索引
        db.books.ensureIndex({number:1})
     3.再执行第一部的代码可以看出有数量级的性能提升
2.索引使用需要注意的地方
     1.创建索引的时候注意1是正序创建索引-1是倒序创建索引
     2.索引的创建在提高查询性能的同事会影响插入的性能
        对于经常查询少插入的文档可以考虑用索引
     3.符合索引要注意索引的先后顺序
     4.每个键全建立索引不一定就能提高性能呢
         索引不是万能的
     5.在做排序工作的时候如果是超大数据量也可以考虑加上索引
         用来提高排序的性能
3.索引的名称
    3.1用VUE查看索引名称
    3.2创建索引同时指定索引的名字
        db.books.ensureIndex({name:-1},{name:”bookname”})
4.唯一索引
 4.1如何解决文档books不能插入重复的数值
       建立唯一索引
       db.books.ensureIndex({name:-1},{unique:true})
       试验
       db.books .insert({name:”1book”})
5.踢出重复值
  5.1如果建议唯一索引之前已经有重复数值如何处理
       db.books.ensureIndex({name:-1},{unique:true,dropDups:true})
6.Hint
  6.1如何强制查询使用指定的索引呢?
        db.books.find({name:&quot;1book&quot;,number:1}).hint({name:-1})
        指定索引必须是已经创建了的索引
7.Expain
    7.1如何详细查看本次查询使用那个索引和查询数据的状态信息
        db.books.find({name:&quot;1book&quot;}).explain()
          “cursor” : “BtreeCursor name_-1“ 使用索引
          “nscanned” : 1 查到几个文档
          “millis” : 0 查询时间0是很不错的性能
</code></pre><p>19、索引管理</p>
<pre><code>1.system.indexes
    1.1在shell查看数据库已经建立的索引
          db.system.indexes.find()
          db.system.namespaces.find()
2.后台执行
    2.1执行创建索引的过程会暂时锁表问题如何解决?
          为了不影响查询我们可以叫索引的创建过程在后台
          db.books.ensureIndex({name:-1},{background:true})
3.删除索引
    3.1批量和精确删除索引
          db.runCommand({dropIndexes : ”books” , index:”name_-1”})
          db.runCommand({dropIndexes : ”books” , index:”*”})
</code></pre><p>20、空间索引</p>
<pre><code>1.查询出距离点(70,180)最近的3个点
    添加2D索引
    db.map.ensureIndex({&quot;gis&quot;:&quot;2d&quot;},{min:-1,max:201})
    默认会建立一个[-180,180]之间的2D索引
    查询点(70,180)最近的3个点
    db.map.find({&quot;gis&quot;:{$near:[70,180]}},{gis:1,_id:0}).limit(3)
2.查询以点(50,50)和点(190,190)为对角线的正方形中的所有的点
     db.map.find({gis:{&quot;$within&quot;:{$box:[[50,50],[190,190]]}}},{_id:0,gis:1})
3.查询出以圆心为(56,80)半径为50规则下的圆心面积中的点
     db.map.find({gis:{$within:{$center:[[56,80],50]}}},{_id:0,gis:1})
</code></pre><p>21、Count+Distinct+Group</p>
<pre><code>1.Count
请查询persons中美国学生的人数.
 db.persons.find({country:&quot;USA&quot;}).count()
2.Distinct
 请查询出persons中一共有多少个国家分别是什么.
  db.runCommand({distinct:&quot;persons“ , key:&quot;country&quot;}).values
3.Group
  语法:
  db.runCommand({group:{
           ns:集合名字,
        Key:分组的键对象,
        Initial:初始化累加器,
        $reduce:组分解器,
        Condition:条件,
        Finalize:组完成器
     }})
  分组首先会按照key进行分组,每组的 每一个文档全要执行$reduce的方法,
  他接收2个参数一个是组内本条记录,一个是累加器数据.
  3.1请查出persons中每个国家学生数学成绩最好的学生信息(必须在90以上
    db.runCommand({group:{
        ns:&quot;persons&quot;,
        key:{&quot;country&quot;:true},
        initial:{m:0},
        $reduce:function(doc,prev){
        if(doc.m &gt; prev.m){
        prev.m = doc.m;
        prev.name = doc.name;
        prev.country = doc.country;
        }
        },
        condition:{m:{$gt:90}}
      }})   
    3.2在3.1要求基础之上吧没个人的信息链接起来写一个描述赋值到m上
        finalize:function(prev){
         prev.m = prev.name+&quot; Math scores &quot;+prev.m
        }
4.用函数格式化分组的键
    4.1如果集合中出现键Counrty和counTry同时存在那分组有点麻烦这要如何解决呢?
        $keyf:function(doc){
                return {country:doc.counTry}
        },…..
</code></pre><p>21、数据库命令操作</p>
<pre><code>1.命令执行器runCommand
     1.1用命令执行完成一次删除表的操作
    db.runCommand({drop:&quot;map&quot;})
    {
            &quot;nIndexesWas&quot; : 2,
            &quot;msg&quot; : &quot;indexes dropped for collection&quot;,
            &quot;ns&quot; : &quot;foobar.map&quot;,
            &quot;ok&quot; : 1
    }
2.如何查询mongoDB为我们提供的命令  
         1.在shell中执行 db.listCommands()
         2.访问网址http://localhost:28017/_commands
3.常用命令举例 
         3.1查询服务器版本号和主机操作系统
         db.runCommand({buildInfo:1})    
         3.2查询执行集合的详细信息,大小,空间,索引等……
         db.runCommand({collStats:&quot;persons&quot;})
         3.3查看操作本集合最后一次错误信息
         db.runCommand({getLastError:&quot;persons&quot;})
</code></pre><p>22、固定集合特性</p>
<pre><code>2.固定特性
    2.1固定集合默认是没有索引的就算是_id也是没有索引的
    2.2由于不需分配新的空间他的插入速度是非常快的
    2.3固定集合的顺是确定的导致查询速度是非常快的
    2.4最适合的是应用就是日志管理
3.创建固定集合
    3.1创建一个新的固定集合要求大小是100个字节,可以存储文档10个
         db.createCollection(&quot;mycoll&quot;,{size:100,capped:true,max:10})
    3.2把一个普通集合转换成固定集合
         db.runCommand({convertToCapped:”persons”,size:100000})
4.反向排序,默认是插入顺序排序.
    4.1查询固定集合mycoll并且反响排序
         db.mycoll.find().sort({$natural:-1})
5.尾部游标,可惜shell不支持java和php等驱动是支持的
    5.1尾部游标概念
         这是个特殊的只能用到固定级和身上的游标,他在没有结果的时候
         也不回自动销毁他是一直等待结果的到来
</code></pre><p>23、GridFS文件系统</p>
<pre><code>1.概念
      GridFS是mongoDB自带的文件系统他用二进制的形式存储文件
      大型文件系统的绝大多是特性GridFS全可以完成
2.利用的工具
3.使用GridFS
   3.1查看GridFS的所有功能
       cmdmongofiles
   3.2上传一个文件
       mongofiles -d foobar -l &quot;E:\a.txt&quot; put &quot;a.txt“
   3.3查看GridFS的文件存储状态
        利用VUE查看   
        集合查看
       db.fs.chunks.find() 和db.fs.files.find() 存储了文件系统的所有文件信息
    3.4查看文件内容
        C:\Users\thinkpad&gt;mongofiles -d foobar get &quot;a.txt“
        VUE可以查看,shell无法打开文件
    3.5查看所有文件
         mongofiles -d foobar list
    3.5删除已经存在的文件VUE中操作
         mongofiles -d foobar delete &apos;a.txt&apos;
</code></pre><p>24、服务器端脚本</p>
<pre><code>1.Eval
    1.1服务器端运行eval
      db.eval(&quot;function(name){ return name}&quot;,&quot;uspcat&quot;)
2.Javascript的存储
    2.1在服务上保存js变量活着函数共全局调用
      1.把变量加载到特殊集合system.js中
         db.system.js.insert({_id:name,value:”uspcat”})
      2.调用
         db.eval(&quot;return  name;&quot;)
    System.js相当于Oracle中的存储过程,因为value不单单可以写变量
    还可以写函数体也就是javascript代码
</code></pre><p>25、mongoDB启动配置详讲</p>
<pre><code>1.1利用config配置文件来启动数据库改变端口为8888
   mongodb.conf文件
   dbpath = D:\sortware\mongod\db 
   port = 8888
   启动文件
   cd C:\Users\thinkpad\Desktop\MONGODB\mongodb-win32-x86_64-2.0.6
   bin\mongod.exe --config ../mongodb.conf
   shell文件
   mongo 127.0.0.1:8888
2.停止mongoDB服务
 1.1ctrl+c 组合键可以关闭数据库
 1.2admin数据库命令关闭数据
</code></pre><p>26、导出和导入，运行时备份</p>
<pre><code>1.导出数据(中断其他操作)
    打开CMD
    利用mongoexport
        -d 指明使用的库
        -c 指明要导出的表
        -o 指明要导出的文件名
        -csv 制定导出的csv格式
        -q 过滤导出
        --type &lt;json|csv|tsv&gt;
   1.1把数据好foobar中的persons导出
        mongoexport -d foobar -c persons -o D:/persons.json
     1.2导出其他主机数据库的文档
     mongoexport --host 192.168.0.16 --port 37017
2.导入数据(中断其他操作)
    API
    http://cn.docs.mongodb.org/manual/reference/mongoimport/
    2.1到入persons文件
    mongoimport --db foobar --collection persons --file d:/persons.json

1.运行时备份mongodump
   API
   http://cn.docs.mongodb.org/manual/reference/mongodump/
  1.1导出127.0.0.1服务下的27017下的foobar数据库
   mongodump --host 127.0.0.1:27017 -d foobar -o d:/foobar
2.运行时恢复mongorestore
   API
   http://cn.docs.mongodb.org/manual/reference/mongorestore/
   2.1删除原本的数据库用刚才导出的数据库恢复
   db.dropDatabase()
   mongorestore --host 127.0.0.1:27017 -d foobar -directoryperdb d:/foobar/foobar
3.懒人备份
   mongoDB是文件数据库这其实就可以用拷贝文件的方式进行备份
</code></pre><p>27、Fsync锁，数据修复</p>
<pre><code>2.上锁和解锁
    上锁
         db.runCommand({fsync:1,lock:1});
    解锁
         db.currentOp()
3.数据修复
     当停电等不可逆转灾难来临的时候,由于mongodb的存储结构导致
     会产生垃圾数据,在数据恢复以后这垃圾数据依然存在,这是数据库
     提供一个自我修复的能力.使用起来很简单
     db.repairDatabase()
</code></pre><p>28、用户管理，安全认证</p>
<pre><code>1.添加一个用户
    1.1为admin添加uspcat用户和foobar数据库的yunfengcheng用户
     use admin
     db.addUser(“uspcat”,”123”);
     use foobar
     db.addUser(“yunfengcheng”,”123”);
2.启用用户
     db.auth(“名称”,”密码”)
3.安全检查 --auth
    非foobar是不能操作数据库的
    非admin数据库的用户不能使用数据库命令
    admin数据库中的数据经过认证为管理员用户
4.用户删除操作
   db.system.users.remove({user:&quot;yunfengcheng&quot;});
    启用自己的用户才能访问
</code></pre><p>29、主从复制</p>
<pre><code>1.主从复制是一个简单的数据库同步备份的集群技术
    1.1在数据库集群中要明确的知道谁是主服务器,主服务器只有一台.
    1.2从服务器要知道自己的数据源也就是对于的主服务是谁.
    1.3--master用来确定主服务器,--slave 和 –source 来控制曾服务器
案例
    主：dbpath = D:\sortware\mongod\01\8888   主数据库地址
    port = 8888 主数据库端口号
    bind_ip = 127.0.0.1 主数据库所在服务器
    master = true 确定我是主服务器

    从：dbpath = D:\sortware\mongod\01\7777   从数据库地址
    port = 7777 从数据库端口号
    bind_ip = 127.0.0.1 从数据库所在服务器
    source = 127.0.0.1:8888 确定我数据库端口
    slave = true 确定自己是从服务器

2.主从复制的其他设置项
    --only  从节点指定复制某个数据库,默认是复制全部数据库
    --slavedelay  从节点设置主数据库同步数据的延迟(单位是秒)
    --fastsync 从节点以主数据库的节点快照为节点启动从数据库
    --autoresync 从节点如果不同步则从新同步数据库
    --oplogSize  主节点设置oplog的大小(主节点操作记录存储到local的oplog中)
3.利用shell动态添加和删除从节点
    不难看出从节点中关于主节点的信息全部存到local的sources的集合中
    我们只要对集合进行操作就可以动态操作主从关系
    挂接主节点:操作之前只留下从数据库服务
    db.sources.insert({“host”:”127.0.0.1:8888”})
    删除已经挂接的主节点:操作之前只留下从数据库服务
    db.sources.remove({“host”:”127.0.0.1:8888”}) 
</code></pre><p>30、副本集</p>
<pre><code>1.副本集概念
    1.1第一张图表明A是活跃的B和C是用于备份的
    1.2第二张图当A出现了故障,这时候集群根据权重算法推选出B为活跃的数据库
    1.3第三张图当A恢复后他自动又会变为备份数据库

    A:dbpath = D:\sortware\mongod\02\A
    port = 1111  #端口
    bind_ip = 127.0.0.1 #服务地址
    replSet = child/127.0.0.1:2222 #设定同伴

    B:dbpath = D:\sortware\mongod\02\B
    port = 2222
    bind_ip = 127.0.0.1
    replSet = child/127.0.0.1:3333

    C:dbpath = D:\sortware\mongod\02\C
    port = 3333
    bind_ip = 127.0.0.1
    replSet = child/127.0.0.1:1111

2.初始化副本集
    use admin
    db.runCommand({&quot;replSetInitiate&quot;:
       {
          &quot;_id&quot;:&apos;child&apos;,
           &quot;members&quot;:[{
                &quot;_id&quot;:1,
            &quot;host&quot;:&quot;127.0.0.1:1111&quot;
            },{
            &quot;_id&quot;:2,
            &quot;host&quot;:&quot;127.0.0.1:2222&quot;
            },{
            &quot;_id&quot;:3,
            &quot;host&quot;:&quot;127.0.0.1:3333&quot;
            }]
        }
    })
    2.查看副本集状态
    rs.status()
3.节点和初始化高级参数
     standard 常规节点:参与投票有可能成为活跃节点
     passive 副本节点:参与投票,但是不能成为活跃节点
     arbiter 仲裁节点:只是参与投票不复制节点也不能成为活跃节点
4.高级参数
    Priority  0到1000之间 ,0代表是副本节点 ,1到1000是常规节点
    arbiterOnly : true 仲裁节点
    用法
    members&quot;:[{
    &quot;_id&quot;:1,
    &quot;host&quot;:&quot;127.0.0.1:1111“,
    arbiterOnly : true
    }]”
5.优先级相同时候仲裁组建的规则
6.读写分离操作扩展读
    6.1一般情况下作为副本的节点是不能进行数据库读操作的
      但是在读取密集型的系统中读写分离是十分必要的
    6.2设置读写分离
      slaveOkay :  true
      很遗憾他在shell中无法掩饰,这个特性是被写到mongoDB的
      驱动程序中的,在java和node等其他语言中可以完成
7.Oplog
     他是被存储在本地数据库local中的,他的每一个文档保证这一个节点操作
     如果想故障恢复可以更彻底oplog可已经尽量设置大一些用来保存更多的操作
     信息
     改变oplog大小
     主库 --master --oplogSize  size
</code></pre><p>31、分片</p>
<pre><code>3.什么时候用到分片呢?
    3.1机器的磁盘空间不足
    3.2单个的mongoDB服务器已经不能满足大量的插入操作
    3.3想通过把大数据放到内存中来提高性能
4.分片步骤
    4.1创建一个配置服务器
    4.2创建路由服务器,并且连接配置服务器
         路由器是调用mongos命令
    4.3添加2个分片数据库
          8081和8082
    4.5利用路由为集群添加分片(允许本地访问)
     db.runCommand({addshard:&quot;127.0.0.1:8081&quot;,allowLocal:true})
     db.runCommand({addshard:&quot;127.0.0.1:8081&quot;,allowLocal:true})
         切记之前不能使用任何数据库语句
    4.6打开数据分片功能,为数据库foobar打开分片功能
        db.runCommand({&quot;enablesharding&quot;:&quot;foobar&quot;})
    4.7对集合进行分片
        db.runCommand({&quot;shardcollection&quot;:&quot;foobar.bar&quot;,&quot;key&quot;:{&quot;_id&quot;:1}})
    4.8利用大数据量进行测试 (800000条)  

5.查看配置库对于分片服务器的配置存储
    db.printShardingStatus()
6.查看集群对bar的自动分片机制配置信息
    mongos&gt; db.shards.find()
    { &quot;_id&quot; : &quot;shard0000&quot;, &quot;host&quot; : &quot;127.0.0.1:8081&quot; }
    { &quot;_id&quot; : &quot;shard0001&quot;, &quot;host&quot; : &quot;127.0.0.1:8082&quot; }
</code></pre>
                
<p class="pink-link-context">
    <a href="/2017/07/22/CSS3笔记/" rel="next" title="CSS3笔记">
    上一篇：CSS3笔记
  </a>
</p>



<p class="pink-link-context">
    <a href="/2017/07/22/node/" rel="next" title="node基础知识">
    下一篇：node基础知识
  </a>
</p>


            </div>
			
        </div>
    </div>
</article>






</div>

        <div class="fixed-action-btn float-sitemap">
    <a class="btn-floating btn-large pink">
      <i class="fa fa-caret-square-o-up"></i>
    </a>
    <ul>
      <li><a class="btn-return-top btn-floating waves-effect green" title="回到顶部"><i class="fa fa-arrow-circle-o-up"></i></a></li>
      <li><a class="btn-floating waves-effect button-collapse yellow darken-1"  data-activates="main-menu" title="菜单"><i class="fa fa-navicon"></i></a></li>
    </ul>
  </div>

    </main>
    <footer class="page-footer indigo darken-1">
    
    <div class="footer-container container">
        <div class="row">
            
            <div class="social-group col m4 s12">
                <h5 class="white-text">社交</h5>
                
                    <a class="social-link" href="http://weibo.com/6175939680" target="_blank">
                        <i class="fa fa-2x fa-weibo"></i>
                    </a>
                
                    <a class="social-link" href="https://github.com/wangchengzou" target="_blank">
                        <i class="fa fa-2x fa-github"></i>
                    </a>
                
                    <a class="social-link" href="/atom.xml" target="_blank">
                        <i class="fa fa-2x fa-rss"></i>
                    </a>
                
                
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
    </script>
    <div class="site-visitors-container white-text">
        <span>
            <i class="fa fa-user"></i>
            <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
        </span>
        <span>&nbsp;|&nbsp;</span>
        <span>
            <i class="fa fa-eye"></i>
            <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
        </span>
    </div>


            </div>
            

            
            <div class="col m8 s12">
                <h5 class="white-text">友情链接</h5>
                
                    <a class="social-link" href="http://www.qianfandu@163.com" target="_blank">网易邮箱</a>
                
                    <a class="social-link" href="https://github.com/wangchengzou" target="_blank">Github</a>
                
                    <a class="social-link" href="http://www.baidu.com" target="_blank">百度</a>
                
            </div>
            
        </div>
    </div>
    

    <div class="footer-copyright pink-link-context">
        <div class="container">
            © 2017 example.com, All rights reserved.
            <p class="right" style="margin-top: 0;">本博客由 <a href="https://hexo.io">Hexo</a> 强力驱动 | 主题 <a href="https://github.com/wangchengzou">ChengZou Wang</a></p>
        </div>
    </div>
</footer>


    <noscript>
    <div class="noscript">
        <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
    </div>
</noscript>
<div class="noscript">
    <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
</div>


<script src="/js/jquery.min.js"></script>
<script src="/js/materialize.min.js"></script>

<script>
    (function($) {
        $(document).ready(function() {
            // 隐藏禁用javascript（针对微信内置浏览器）的提示
            $('.noscript').hide();

            // 图片缩放效果
            var $imgs = $('img').not('.slider-image').not('.avatar-image').not('.carousel-image').not('.card-cover-image').not('.qrcode');

            // 给图片加上点击放大效果（materialbox插件）
            $imgs.addClass('materialboxed').each(function(i, el) {
                $(this).attr('data-caption', $(this).attr('alt') || ' ');
            }).materialbox();

            // 优化表格的显示
            $('table').each(function() {
                var $table = $(this);
                // 除去多行代码的情况
                if ($table.find('pre').length == 0) {
                    $table.addClass('responsive-table striped bordered');
                }
            });

            // 首页幻灯片
            $('.slider').slider({indicators: true, full_width: true, interval: 8000});

            $(".button-collapse").sideNav();
            $(".category-menu").sideNav();

            // 针对gallery post
            $('.carousel').carousel({full_width: true});
            $('.carousel-control.prev').click(function() {
                $('.carousel').carousel('prev');
            });
            $('.carousel-control.next').click(function() {
                $('.carousel').carousel('next');
            });

            // 文章目录
            $('article').not('.simple-article').find('h1').add('h2').add('h3').add('h4').add('h5').add('h6').scrollSpy();

            // 目录随屏幕滚动（防止目录过长越过footer）
            var $toc = $('.toc');
            var scrollTargetTop = 0;
            $(window).scroll(function() {
                var $activeLink = $toc.find('a.active.section');
                if ($(window).scrollTop() < 100) {
                    scrollTargetTop = 0;
                } else {
                    if ($activeLink[0]) {
                        scrollTargetTop = $activeLink.offset().top - $toc.offset().top;
                    }
                }
                $toc.css('top', '-' + scrollTargetTop + 'px');
            });

            // 修正文章目录的left-border颜色
            var color = $('.table-of-contents-text').css('color');
            $('.table-of-contents-link').css('border-left-color', color);

            // 针对移动端做的优化：FAB按钮点击一下收回
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                $('.fixed-action-btn').addClass('click-to-toggle');
            }
            // 回到顶部
            $('.btn-return-top').click(function() {
                $('body, html').animate({
                    scrollTop: 0
                }, 500);
            });

            // 重置读书页面的Tab标签页的颜色
            $('li.tab a').hover(function() {
                $(this).toggleClass('text-lighten-4');
            });
            $('.indicator').addClass('pink lighten-2');

            
            // 添加new标签
            $('.menu-reading, .menu-about').append('<span class="new badge pink"></span>');
            

            // 搜索功能
            $('.modal-trigger').leanModal({
                // 打开搜索框时自动聚焦
                ready: function() {
                    if ($('#search').is(":visible")) {
                        $('#search-input').focus();
                    }
                }
            });
            var searchXml = "";
            if (searchXml.length == 0) {
             	searchXml = "search.xml";
            }
            var searchPath = "/" + searchXml;
            initSearch(searchPath, 'search-input', 'search-result');
        });

        // 初始化搜索与匹配函数
        var initSearch = function(path, search_id, content_id) {
            'use strict';
            $.ajax({
                url: path,
                dataType: "xml",
                success: function(xmlResponse) {
                    // get the contents from search data
                    var datas = $("entry", xmlResponse).map(function() {
                        return {
                            title: $("title", this).text(),
                            content: $("content", this).text(),
                            url: $("url", this).text()
                        };
                    }).get();
                    var $input = document.getElementById(search_id);
                    var $resultContent = document.getElementById(content_id);
                    $input.addEventListener('input', function() {
                        var str = '<ul class=\"search-result-list\">';
                        var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                        $resultContent.innerHTML = "";
                        if (this.value.trim().length <= 0) {
                            return;
                        }
                        // perform local searching
                        datas.forEach(function(data) {
                            var isMatch = true;
                            var content_index = [];
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty titles and contents
                            if (data_title != '' && data_content != '') {
                                keywords.forEach(function(keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);
                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            }
                            // show search results
                            if (isMatch) {
                                keywords.forEach(function(keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    data_title = data_title.replace(regS, "<span class=\"search-keyword pink lighten-2\">" + keyword + "</span>");
                                });

                                str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 100 characters
                                    var start = first_occur - 20;
                                    var end = first_occur + 80;
                                    if (start < 0) {
                                        start = 0;
                                    }
                                    if (start == 0) {
                                        end = 100;
                                    }
                                    if (end > content.length) {
                                        end = content.length;
                                    }
                                    var match_content = content.substring(start, end);
                                    // highlight all keywords
                                    keywords.forEach(function(keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, "<span class=\"search-keyword pink lighten-2\">" + keyword + "</span>");
                                    });

                                    str += "<p class=\"search-result\">..." + match_content + "...</p>"
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        $resultContent.innerHTML = str;
                    });
                }
            });
        }
    })(jQuery);
</script>


<script src="/js/prettify.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("pre").addClass("prettyprint");
        prettyPrint();
    });
</script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>
<script type="text/javascript" async
  src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>



</body>
</html>
